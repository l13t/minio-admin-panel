<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
            color: white;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem 1.5rem;
            border-radius: 0;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }

        .logo {
            color: #C72E29;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .status-enabled {
            color: #28a745;
        }

        .status-disabled {
            color: #dc3545;
        }

        .user-access-key {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }

        .access-key-only-view .user-status,
        .access-key-only-view .user-policy,
        .access-key-only-view .user-groups {
            display: none;
        }

        .access-key-only-view th:nth-child(2),
        .access-key-only-view th:nth-child(3),
        .access-key-only-view th:nth-child(4) {
            display: none;
        }

        .copy-success {
            color: #28a745;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            {{template "sidebar.html" .}}

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">{{t "users.title"}}</h1>
                    <div>
                        <button type="button" class="btn btn-outline-info me-2" onclick="exportAccessKeys()">
                            <i class="fas fa-download me-2"></i>{{t "common.export"}}
                        </button>
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="toggleView()">
                            <i class="fas fa-eye me-2"></i>{{t "ui.toggle_view"}}
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                            <i class="fas fa-user-plus me-2"></i>{{t "users.create_user"}}
                        </button>
                    </div>
                </div>

                <!-- View Toggle Info -->
                <div class="alert alert-info" id="viewInfo">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="viewInfoText">{{t "info.showing_detailed_view"}}</span>
                </div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead id="tableHeader">
                                    <tr>
                                        <th>{{t "users.access_key"}}</th>
                                        <th>{{t "users.status"}}</th>
                                        <th>{{t "users.policy"}}</th>
                                        <th>{{t "users.groups"}}</th>
                                        <th>{{t "users.actions"}}</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    {{range .users}}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-key me-2 text-primary"></i>
                                                <code class="user-access-key me-2">{{.AccessKey}}</code>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="copyAccessKey('{{.AccessKey}}')" title="{{t " tooltip.copy_access_key"}}">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td class="user-status">
                                            {{if eq .Status "enabled"}}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Enabled
                                            </span>
                                            {{else}}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Disabled
                                            </span>
                                            {{end}}
                                        </td>
                                        <td class="user-policy">
                                            {{if .PolicyName}}
                                            <span class="badge bg-info">{{.PolicyName}}</span>
                                            {{else}}
                                            <span class="text-muted">{{t "ui.no_policy"}}</span>
                                            {{end}}
                                        </td>
                                        <td class="user-groups">
                                            {{range .MemberOf}}
                                            <span class="badge bg-secondary me-1">{{.}}</span>
                                            {{else}}
                                            <span class="text-muted">{{t "ui.no_groups"}}</span>
                                            {{end}}
                                        </td>
                                        <td class="user-actions">
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-secondary" onclick="viewUserDetails('{{.AccessKey}}')" title="{{t " tooltip.view_details"}}">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="editUser('{{.AccessKey}}')" title="{{t " tooltip.edit_credentials"}}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" onclick="editUserPolicy('{{.AccessKey}}')" title="{{t " tooltip.edit_policy"}}">
                                                    <i class="fas fa-shield-alt"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="editUserGroups('{{.AccessKey}}')" title="{{t " tooltip.edit_groups"}}">
                                                    <i class="fas fa-layer-group"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="manageServiceAccounts('{{.AccessKey}}')" title="{{t " tooltip.service_accounts"}}">
                                                    <i class="fas fa-key"></i>
                                                </button>
                                                {{if eq .Status "enabled"}}
                                                <button class="btn btn-sm btn-outline-warning" onclick="toggleUserStatus('{{.AccessKey}}', false)" title="{{t " tooltip.disable_user"}}">
                                                    <i class="fas fa-user-slash"></i>
                                                </button>
                                                {{else}}
                                                <button class="btn btn-sm btn-outline-success" onclick="toggleUserStatus('{{.AccessKey}}', true)" title="{{t " tooltip.enable_user"}}">
                                                    <i class="fas fa-user-check"></i>
                                                </button>
                                                {{end}}
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('{{.AccessKey}}')" title="{{t " tooltip.delete_user"}}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{t "modal.create_new_user"}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createUserForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="userAccessKey" class="form-label">{{t "users.access_key"}}</label>
                            <input type="text" class="form-control" id="userAccessKey" name="access_key" required minlength="3" maxlength="20">
                            <div class="form-text">3-20 characters, alphanumeric</div>
                        </div>
                        <div class="mb-3">
                            <label for="userSecretKey" class="form-label">{{t "users.secret_key"}}</label>
                            <input type="password" class="form-control" id="userSecretKey" name="secret_key" required minlength="8">
                            <div class="form-text">Minimum 8 characters</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmSecretKey" class="form-label">{{t "form.confirm_secret_key"}}</label>
                            <input type="password" class="form-control" id="confirmSecretKey" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">{{t "ui.create_user"}}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{t "ui.user_details"}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>{{t "ui.basic_information"}}</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Access Key:</strong></td>
                                    <td><code id="detailsAccessKey">-</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span id="detailsStatus">-</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Policy:</strong></td>
                                    <td><span id="detailsPolicy">-</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Groups:</strong></td>
                                    <td><span id="detailsGroups">-</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Last Updated:</strong></td>
                                    <td><span id="detailsUpdatedAt">-</span></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>{{t "users.actions"}}</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-info" onclick="editUserFromDetails()">
                                    <i class="fas fa-edit me-2"></i>Edit Credentials
                                </button>
                                <button class="btn btn-outline-primary" onclick="editUserPolicyFromDetails()">
                                    <i class="fas fa-shield-alt me-2"></i>Edit Policy
                                </button>
                                <button class="btn btn-outline-secondary" onclick="copyAccessKeyFromDetails()">
                                    <i class="fas fa-copy me-2"></i>Copy Access Key
                                </button>
                                <button class="btn btn-outline-secondary" onclick="editUserGroupsFromDetails()">
                                    <i class="fas fa-users me-2"></i>Edit Groups
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{t "ui.edit_user_credentials"}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserForm">
                    <div class="modal-body">
                        <input type="hidden" id="editUserAccessKey" name="access_key">

                        <!-- Current Credentials Section -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">{{t "ui.current_credentials"}}</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="editUserAccessKeyDisplay" class="form-label">{{t "users.access_key"}}</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="editUserAccessKeyDisplay" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('editUserAccessKeyDisplay')" title="{{t " tooltip.copy_access_key"}}">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editUserCurrentSecretKey" class="form-label">{{t "ui.current_secret_key"}}</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="editUserCurrentSecretKey" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleSecretKeyVisibility('editUserCurrentSecretKey')" title="{{t " tooltip.toggle_visibility"}}">
                                            <i class="fas fa-eye" id="editUserCurrentSecretKeyIcon"></i>
                                        </button>
                                    </div>
                                    <div class="form-text text-muted">{{t "ui.secret_key_masked"}}</div>
                                </div>
                                <div class="mb-0">
                                    <small class="text-muted">
                                        <strong>Status:</strong> <span id="editUserStatus">-</span> |
                                        <strong>Policy:</strong> <span id="editUserPolicy">-</span> |
                                        <strong>Last Updated:</strong> <span id="editUserUpdated">-</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- New Credentials Section -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">{{t "ui.update_secret_key"}}</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="editUserSecretKey" class="form-label">New Secret Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="editUserSecretKey" name="secret_key" minlength="8" placeholder="{{t " form.enter_new_secret_key"}}">
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleSecretKeyVisibility('editUserSecretKey')" title="{{t " tooltip.toggle_visibility"}}">
                                            <i class="fas fa-eye" id="editUserSecretKeyIcon"></i>
                                        </button>
                                        <button class="btn btn-outline-info" type="button" onclick="generateSecretKey()" title="{{t " tooltip.generate_random_secret_key"}}">
                                            <i class="fas fa-random"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Minimum 8 characters. Leave empty to keep current secret key.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editConfirmSecretKey" class="form-label">Confirm New Secret Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="editConfirmSecretKey">
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleSecretKeyVisibility('editConfirmSecretKey')" title="{{t " tooltip.toggle_visibility"}}">
                                            <i class="fas fa-eye" id="editConfirmSecretKeyIcon"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Credentials</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Policy Modal -->
    <div class="modal fade" id="editPolicyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User Policy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editPolicyForm">
                    <div class="modal-body">
                        <input type="hidden" id="editPolicyAccessKey" name="access_key">
                        <div class="mb-3">
                            <label for="editPolicyAccessKeyDisplay" class="form-label">User</label>
                            <input type="text" class="form-control" id="editPolicyAccessKeyDisplay" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="userPolicy" class="form-label">Policy Name</label>
                            <select class="form-select" id="userPolicy" name="policy" required>
                                <option value="">Loading policies...</option>
                            </select>
                            <div class="form-text">Select a policy to assign to this user</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Policy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Groups Modal -->
    <div class="modal fade" id="editUserGroupsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User Groups</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserGroupsForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="userNameGroupsDisplay" class="form-label">User</label>
                            <input type="text" class="form-control" id="userNameGroupsDisplay" readonly>
                            <input type="hidden" id="editGroupsUserName" name="userName">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Current Groups</label>
                            <div id="currentUserGroups" class="border rounded p-3 bg-light">
                                <span class="text-muted">Loading...</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="userGroupsSelect" class="form-label">Select Groups</label>
                            <select multiple class="form-control" id="userGroupsSelect" name="groups" size="6">
                                <option disabled>Loading groups...</option>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple groups</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Update Groups
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Service Accounts Modal -->
    <div class="modal fade" id="serviceAccountsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Service Accounts for <span id="serviceAccountUsername"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" onclick="showCreateServiceAccountForm()">
                            <i class="fas fa-plus me-1"></i>Create Service Account
                        </button>
                    </div>

                    <!-- Create Service Account Form (initially hidden) -->
                    <div id="createServiceAccountForm" class="card mb-3" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">{{t "modal.create_new_service_account"}}</h6>
                        </div>
                        <div class="card-body">
                            <form id="createServiceAccountFormElement">
                                <div class="mb-3">
                                    <label for="serviceAccountName" class="form-label">Name (optional)</label>
                                    <input type="text" class="form-control" id="serviceAccountName" name="name" placeholder="{{t " form.service_account_name"}}">
                                </div>
                                <div class="mb-3">
                                    <label for="serviceAccountDescription" class="form-label">Description
                                        (optional)</label>
                                    <textarea class="form-control" id="serviceAccountDescription" name="description" rows="2" placeholder="{{t " form.service_account_description"}}"></textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus me-1"></i>Create
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="hideCreateServiceAccountForm()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Service Account Credentials Display (initially hidden) -->
                    <div id="serviceAccountCredentials" class="alert alert-success" style="display: none;">
                        <h6><i class="fas fa-key me-2"></i>{{t "success.service_account_created"}}</h6>
                        <p class="mb-2"><strong>Access Key:</strong> <code id="newServiceAccountAccessKey"></code>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard(document.getElementById('newServiceAccountAccessKey').textContent)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </p>
                        <p class="mb-2"><strong>Secret Key:</strong> <code id="newServiceAccountSecretKey"></code>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard(document.getElementById('newServiceAccountSecretKey').textContent)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </p>
                        <p class="mb-0 text-warning"><i class="fas fa-exclamation-triangle me-1"></i><strong>Important:</strong> Save these
                            credentials now. The secret key will not be shown again.</p>
                    </div>

                    <!-- Service Accounts List -->
                    <div id="serviceAccountsList">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading service accounts...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Translation variables for JavaScript
        const translations = {
            copyAccessKey: '{{t "tooltip.copy_access_key"}}',
            deleteServiceAccount: '{{t "tooltip.delete_service_account"}}',
            copied: '{{t "ui.copied_to_clipboard"}}',
            name: '{{t "common.name"}}',
            description: '{{t "common.description"}}',
            parentUser: '{{t "service_accounts.parent_user"}}'
        };

        let isAccessKeyOnlyView = false;

        // Copy access key to clipboard
        async function copyAccessKey(accessKey) {
            try {
                await navigator.clipboard.writeText(accessKey);

                // Visual feedback
                const button = event.target.closest('button');
                const icon = button.querySelector('i');
                const originalClass = icon.className;

                icon.className = 'fas fa-check copy-success';
                button.title = translations.copied;

                setTimeout(() => {
                    icon.className = originalClass;
                    button.title = translations.copyAccessKey;
                }, 2000);

                console.log(`Access key copied: ${accessKey}`);
            } catch (err) {
                console.error('Failed to copy access key:', err);

                // Fallback: select text
                const range = document.createRange();
                const selection = window.getSelection();
                const accessKeyElement = event.target.closest('td').querySelector('.user-access-key');
                range.selectNodeContents(accessKeyElement);
                selection.removeAllRanges();
                selection.addRange(range);

                alert('Access key selected. Press Ctrl+C to copy.');
            }
        }

        // Toggle between full view and access keys only view
        function toggleView() {
            const table = document.getElementById('usersTable');
            const viewInfo = document.getElementById('viewInfoText');

            isAccessKeyOnlyView = !isAccessKeyOnlyView;

            if (isAccessKeyOnlyView) {
                table.classList.add('access-key-only-view');
                viewInfo.textContent = '{{t "info.showing_keys_view"}}';

                // Update table header
                const header = document.getElementById('tableHeader');
                header.innerHTML = `
                    <tr>
                        <th>Access Key</th>
                        <th>Actions</th>
                    </tr>
                `;
            } else {
                table.classList.remove('access-key-only-view');
                viewInfo.textContent = '{{t "info.showing_detailed_view"}}';

                // Restore full table header
                const header = document.getElementById('tableHeader');
                header.innerHTML = `
                    <tr>
                        <th>Access Key</th>
                        <th>Status</th>
                        <th>Policy</th>
                        <th>Groups</th>
                        <th>Actions</th>
                    </tr>
                `;
            }

            console.log(`View toggled: ${isAccessKeyOnlyView ? 'Access Keys Only' : 'Full View'}`);
        }

        // Export access keys to CSV
        function exportAccessKeys() {
            try {
                // Get all access keys from the table
                const accessKeys = [];
                const rows = document.querySelectorAll('#usersTableBody tr');

                rows.forEach(row => {
                    const accessKeyElement = row.querySelector('.user-access-key');
                    const statusElement = row.querySelector('.user-status .badge');
                    const policyElement = row.querySelector('.user-policy .badge');

                    if (accessKeyElement) {
                        const accessKey = accessKeyElement.textContent.trim();
                        const status = statusElement ? statusElement.textContent.trim() : 'Unknown';
                        const policy = policyElement ? policyElement.textContent.trim() : 'No policy';

                        accessKeys.push({
                            accessKey,
                            status,
                            policy
                        });
                    }
                });

                // Create CSV content
                const csvHeader = 'Access Key,Status,Policy\\n';
                const csvRows = accessKeys.map(item =>
                    `"${item.accessKey}","${item.status}","${item.policy}"`
                ).join('\\n');
                const csvContent = csvHeader + csvRows;

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `minio-access-keys-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log(`Exported ${accessKeys.length} access keys`);

                // Show success message
                const exportBtn = event.target.closest('button');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-check me-2"></i>Exported!';
                exportBtn.classList.add('btn-success');
                exportBtn.classList.remove('btn-outline-info');

                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.classList.remove('btn-success');
                    exportBtn.classList.add('btn-outline-info');
                }, 2000);

            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export access keys: ' + error.message);
            }
        }

        let currentUserForDetails = '';

        // View user details
        async function viewUserDetails(accessKey) {
            currentUserForDetails = accessKey;

            try {
                // Show loading state
                document.getElementById('detailsAccessKey').textContent = 'Loading...';
                document.getElementById('detailsStatus').textContent = 'Loading...';
                document.getElementById('detailsPolicy').textContent = 'Loading...';
                document.getElementById('detailsGroups').textContent = 'Loading...';
                document.getElementById('detailsUpdatedAt').textContent = 'Loading...';

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                modal.show();

                // Load user details
                const response = await fetch(`/users/${accessKey}/details`);
                if (response.ok) {
                    const data = await response.json();
                    const details = data.details;

                    document.getElementById('detailsAccessKey').textContent = details.access_key || accessKey;

                    // Status with badge
                    const statusElement = document.getElementById('detailsStatus');
                    if (details.status === 'enabled') {
                        statusElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Enabled</span>';
                    } else {
                        statusElement.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Disabled</span>';
                    }

                    // Policy
                    const policyElement = document.getElementById('detailsPolicy');
                    if (details.policy_name) {
                        policyElement.innerHTML = `<span class="badge bg-info">${details.policy_name}</span>`;
                    } else {
                        policyElement.innerHTML = '<span class="text-muted">No policy assigned</span>';
                    }

                    // Groups
                    const groupsElement = document.getElementById('detailsGroups');
                    if (details.member_of && details.member_of.length > 0) {
                        const groupBadges = details.member_of.map(group =>
                            `<span class="badge bg-secondary me-1">${group}</span>`
                        ).join('');
                        groupsElement.innerHTML = groupBadges;
                    } else {
                        groupsElement.innerHTML = '<span class="text-muted">No groups</span>';
                    }

                    // Updated at
                    const updatedElement = document.getElementById('detailsUpdatedAt');
                    if (details.updated_at) {
                        const updatedDate = new Date(details.updated_at);
                        updatedElement.textContent = updatedDate.toLocaleString();
                    } else {
                        updatedElement.innerHTML = '<span class="text-muted">Not available</span>';
                    }

                    console.log(`Loaded details for user: ${accessKey}`);
                } else {
                    console.error('Failed to load user details');
                    document.getElementById('detailsAccessKey').textContent = accessKey;
                    document.getElementById('detailsStatus').textContent = 'Error loading details';
                    document.getElementById('detailsPolicy').textContent = 'Error';
                    document.getElementById('detailsGroups').textContent = 'Error';
                    document.getElementById('detailsUpdatedAt').textContent = 'Error';
                }
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('Failed to load user details: ' + error.message);
            }
        }

        // Helper functions for actions from details modal
        function editUserFromDetails() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
            modal.hide();
            setTimeout(() => editUser(currentUserForDetails), 300);
        }

        function editUserPolicyFromDetails() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
            modal.hide();
            setTimeout(() => editUserPolicy(currentUserForDetails), 300);
        }

        async function copyAccessKeyFromDetails() {
            await copyAccessKey(currentUserForDetails);
        }

        function editUserGroupsFromDetails() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
            modal.hide();
            setTimeout(() => editUserGroups(currentUserForDetails), 300);
        }

        // Load policies for dropdowns
        async function loadPolicies() {
            try {
                const response = await fetch('/api/policies');
                if (response.ok) {
                    const data = await response.json();
                    const policySelect = document.getElementById('userPolicy');
                    policySelect.innerHTML = '<option value="">Select Policy</option>';

                    data.policies.forEach(policy => {
                        const option = document.createElement('option');
                        option.value = policy;
                        option.textContent = policy;
                        policySelect.appendChild(option);
                    });

                    console.log(`Loaded ${data.policies.length} policies`);
                } else {
                    console.error('Failed to load policies');
                    const policySelect = document.getElementById('userPolicy');
                    policySelect.innerHTML = '<option value="">Error loading policies</option>';
                }
            } catch (error) {
                console.error('Error loading policies:', error);
            }
        }

        // Create user
        document.getElementById('createUserForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const secretKey = document.getElementById('userSecretKey').value;
            const confirmSecretKey = document.getElementById('confirmSecretKey').value;

            if (secretKey !== confirmSecretKey) {
                alert('Secret keys do not match');
                return;
            }

            const formData = new FormData(this);

            try {
                const response = await fetch('/users', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error creating user: ' + error.message);
            }
        });

        // Edit user (credentials)
        async function editUser(accessKey) {
            // Set access key
            document.getElementById('editUserAccessKey').value = accessKey;
            document.getElementById('editUserAccessKeyDisplay').value = accessKey;

            // Clear new credential fields
            document.getElementById('editUserSecretKey').value = '';
            document.getElementById('editConfirmSecretKey').value = '';

            // Reset current credential fields with loading state
            document.getElementById('editUserCurrentSecretKey').value = 'Loading...';
            document.getElementById('editUserStatus').textContent = 'Loading...';
            document.getElementById('editUserPolicy').textContent = 'Loading...';
            document.getElementById('editUserUpdated').textContent = 'Loading...';

            try {
                // Load current credentials
                const response = await fetch(`/users/${accessKey}/credentials`);
                if (response.ok) {
                    const result = await response.json();
                    const credentials = result.credentials;

                    // Display current credentials
                    document.getElementById('editUserCurrentSecretKey').value = credentials.secret_key || '••••••••••••••••';
                    document.getElementById('editUserStatus').textContent = credentials.status || 'Unknown';
                    document.getElementById('editUserPolicy').textContent = credentials.policy_name || 'No policy';
                    document.getElementById('editUserUpdated').textContent = credentials.updated_at ?
                        new Date(credentials.updated_at).toLocaleString() : 'Unknown';

                    console.log(`Loaded credentials for ${accessKey}`);
                } else {
                    console.error('Failed to load credentials');
                    document.getElementById('editUserCurrentSecretKey').value = 'Error loading';
                    document.getElementById('editUserStatus').textContent = 'Error';
                    document.getElementById('editUserPolicy').textContent = 'Error';
                    document.getElementById('editUserUpdated').textContent = 'Error';
                }
            } catch (error) {
                console.error('Error loading credentials:', error);
                document.getElementById('editUserCurrentSecretKey').value = 'Error loading';
                document.getElementById('editUserStatus').textContent = 'Error';
                document.getElementById('editUserPolicy').textContent = 'Error';
                document.getElementById('editUserUpdated').textContent = 'Error';
            }

            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        // Update user credentials
        document.getElementById('editUserForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const accessKey = document.getElementById('editUserAccessKey').value;
            const secretKey = document.getElementById('editUserSecretKey').value;
            const confirmSecretKey = document.getElementById('editConfirmSecretKey').value;

            // If secret key is provided, validate it
            if (secretKey) {
                if (secretKey !== confirmSecretKey) {
                    alert('Secret keys do not match');
                    return;
                }

                if (secretKey.length < 8) {
                    alert('Secret key must be at least 8 characters');
                    return;
                }

                try {
                    const response = await fetch(`/users/${accessKey}/credentials`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ secret_key: secretKey })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Close modal and reload page
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                        modal.hide();
                        alert('{{t "success.user_credentials_updated"}}');
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error updating user: ' + error.message);
                }
            } else {
                // No secret key provided, just close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                modal.hide();
            }
        });

        // Toggle user status
        async function toggleUserStatus(accessKey, enabled) {
            const action = enabled ? 'enable' : 'disable';
            if (confirm(`Are you sure you want to ${action} user "${accessKey}"?`)) {
                try {
                    const response = await fetch(`/users/${accessKey}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ enabled: enabled })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert(`Error ${action}ing user: ` + error.message);
                }
            }
        }

        // Delete user
        async function deleteUser(accessKey) {
            if (confirm(`Are you sure you want to delete user "${accessKey}"?`)) {
                try {
                    const response = await fetch(`/users/${accessKey}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error deleting user: ' + error.message);
                }
            }
        }

        // Edit user policy
        async function editUserPolicy(accessKey) {
            document.getElementById('editPolicyAccessKey').value = accessKey;
            document.getElementById('editPolicyAccessKeyDisplay').value = accessKey;

            // Load current user policy
            try {
                const response = await fetch(`/users/${accessKey}/policy`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('userPolicy').value = data.policy || '';
                    console.log(`Current policy for ${accessKey}: ${data.policy || 'none'}`);
                } else {
                    console.log('Failed to load current policy');
                }
            } catch (error) {
                console.error('Error loading current policy:', error);
            }

            const modal = new bootstrap.Modal(document.getElementById('editPolicyModal'));
            modal.show();
        }

        // Update user policy
        document.getElementById('editPolicyForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const accessKey = document.getElementById('editPolicyAccessKey').value;
            const formData = new FormData(this);

            try {
                const response = await fetch(`/users/${accessKey}/policy`, {
                    method: 'PUT',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editPolicyModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating policy: ' + error.message);
            }
        });

        // Edit user groups
        async function editUserGroups(accessKey) {
            document.getElementById('editGroupsUserName').value = accessKey;
            document.getElementById('userNameGroupsDisplay').value = accessKey;

            // Load current user groups
            try {
                const response = await fetch(`/users/${accessKey}/groups`);
                if (response.ok) {
                    const data = await response.json();
                    const groups = data.groups;

                    // Display current groups
                    const currentGroupsElement = document.getElementById('currentUserGroups');
                    currentGroupsElement.innerHTML = '';
                    if (groups && groups.length > 0) {
                        groups.forEach(group => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-1';
                            badge.textContent = group;
                            currentGroupsElement.appendChild(badge);
                        });
                    } else {
                        currentGroupsElement.innerHTML = '<span class="text-muted">No groups</span>';
                    }

                    // Load all groups for selection
                    const allGroupsResponse = await fetch('/api/groups');
                    if (allGroupsResponse.ok) {
                        const allGroupsData = await allGroupsResponse.json();
                        const allGroups = allGroupsData.groups;

                        const userGroupsSelect = document.getElementById('userGroupsSelect');
                        userGroupsSelect.innerHTML = '';

                        allGroups.forEach(group => {
                            const option = document.createElement('option');
                            option.value = group;
                            option.textContent = group;
                            userGroupsSelect.appendChild(option);
                        });

                        // Pre-select user's groups
                        groups.forEach(group => {
                            const option = Array.from(userGroupsSelect.options).find(opt => opt.value === group);
                            if (option) {
                                option.selected = true;
                            }
                        });

                        console.log(`Loaded ${allGroups.length} groups`);
                    } else {
                        console.error('Failed to load groups');
                        document.getElementById('userGroupsSelect').innerHTML = '<option disabled>Error loading groups</option>';
                    }
                } else {
                    console.log('Failed to load current groups');
                }
            } catch (error) {
                console.error('Error loading groups:', error);
            }

            const modal = new bootstrap.Modal(document.getElementById('editUserGroupsModal'));
            modal.show();
        }

        // Update user groups
        document.getElementById('editUserGroupsForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const accessKey = document.getElementById('editGroupsUserName').value;
            const formData = new FormData(this);

            try {
                const response = await fetch(`/users/${accessKey}/groups`, {
                    method: 'PUT',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserGroupsModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating groups: ' + error.message);
            }
        });

        // Service Account Management Functions
        let currentServiceAccountUser = '';

        async function manageServiceAccounts(accessKey) {
            currentServiceAccountUser = accessKey;
            document.getElementById('serviceAccountUsername').textContent = accessKey;

            const modal = new bootstrap.Modal(document.getElementById('serviceAccountsModal'));
            modal.show();

            await loadServiceAccounts(accessKey);
        }

        async function loadServiceAccounts(accessKey) {
            const serviceAccountsList = document.getElementById('serviceAccountsList');
            serviceAccountsList.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading service accounts...</p>
                </div>
            `;

            try {
                const response = await fetch(`/api/service-accounts?user=${encodeURIComponent(accessKey)}`);
                if (response.ok) {
                    const data = await response.json();
                    const serviceAccounts = data.service_accounts || [];

                    if (serviceAccounts.length === 0) {
                        serviceAccountsList.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="fas fa-key fa-3x mb-3"></i>
                                <p>No service accounts found for this user.</p>
                            </div>
                        `;
                    } else {
                        let html = '<div class="list-group">';
                        serviceAccounts.forEach(sa => {
                            const statusClass = sa.status === 'enabled' ? 'text-success' : 'text-danger';
                            const statusIcon = sa.status === 'enabled' ? 'fas fa-check-circle' : 'fas fa-times-circle';

                            html += `
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <code>${sa.access_key}</code>
                                                <span class="${statusClass} ms-2">
                                                    <i class="${statusIcon}"></i> ${sa.status}
                                                </span>
                                            </h6>
                                            ${sa.name ? `<p class="mb-1"><strong>${translations.name}:</strong> ${sa.name}</p>` : ''}
                                            ${sa.description ? `<p class="mb-1"><strong>${translations.description}:</strong> ${sa.description}</p>` : ''}
                                            <small class="text-muted">${translations.parentUser}: ${sa.parent_user}</small>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${sa.access_key}')" title="${translations.copyAccessKey}">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteServiceAccount('${sa.access_key}')" title="${translations.deleteServiceAccount}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        serviceAccountsList.innerHTML = html;
                    }
                } else {
                    serviceAccountsList.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load service accounts: ${response.statusText}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading service accounts:', error);
                serviceAccountsList.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading service accounts: ${error.message}
                    </div>
                `;
            }
        }

        function showCreateServiceAccountForm() {
            document.getElementById('createServiceAccountForm').style.display = 'block';
            document.getElementById('serviceAccountCredentials').style.display = 'none';
        }

        function hideCreateServiceAccountForm() {
            document.getElementById('createServiceAccountForm').style.display = 'none';
            document.getElementById('createServiceAccountFormElement').reset();
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                // Show temporary feedback
                const button = event.target.closest('button');
                const icon = button.querySelector('i');
                const originalClass = icon.className;

                icon.className = 'fas fa-check';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-secondary');

                setTimeout(() => {
                    icon.className = originalClass;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 1500);
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                alert('Failed to copy to clipboard');
            }
        }

        // Handle create service account form submission
        document.getElementById('createServiceAccountFormElement').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                target_user: currentServiceAccountUser,
                name: formData.get('name') || '',
                description: formData.get('description') || ''
            };

            try {
                const response = await fetch('/api/service-accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    const serviceAccount = result.service_account;

                    // Show credentials
                    document.getElementById('newServiceAccountAccessKey').textContent = serviceAccount.access_key;
                    document.getElementById('newServiceAccountSecretKey').textContent = serviceAccount.secret_key;
                    document.getElementById('serviceAccountCredentials').style.display = 'block';

                    // Hide form
                    hideCreateServiceAccountForm();

                    // Reload service accounts list
                    await loadServiceAccounts(currentServiceAccountUser);
                } else {
                    const errorData = await response.json();
                    alert(`Failed to create service account: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Error creating service account:', error);
                alert('Error creating service account: ' + error.message);
            }
        });

        async function deleteServiceAccount(accessKey) {
            if (!confirm(`Are you sure you want to delete service account "${accessKey}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/service-accounts/${encodeURIComponent(accessKey)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Reload service accounts list
                    await loadServiceAccounts(currentServiceAccountUser);
                } else {
                    const errorData = await response.json();
                    alert(`Failed to delete service account: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Error deleting service account:', error);
                alert('Error deleting service account: ' + error.message);
            }
        }

        // ...existing code...
    </script>
</body>

</html>
