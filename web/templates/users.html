<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
            color: white;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem 1.5rem;
            border-radius: 0;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }

        .logo {
            color: #C72E29;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .status-enabled {
            color: #28a745;
        }

        .status-disabled {
            color: #dc3545;
        }

        .user-access-key {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }

        .access-key-only-view .user-status,
        .access-key-only-view .user-policy,
        .access-key-only-view .user-groups {
            display: none;
        }

        .access-key-only-view th:nth-child(2),
        .access-key-only-view th:nth-child(3),
        .access-key-only-view th:nth-child(4) {
            display: none;
        }

        .copy-success {
            color: #28a745;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <i class="fas fa-server logo"></i>
                        <span class="logo ms-2">MinIO Admin</span>
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        {{if .permissions.canListBuckets}}
                        <li class="nav-item">
                            <a class="nav-link" href="/buckets">
                                <i class="fas fa-bucket me-2"></i>Buckets
                            </a>
                        </li>
                        {{end}}
                        {{if .permissions.canManageUsers}}
                        <li class="nav-item">
                            <a class="nav-link active" href="/users">
                                <i class="fas fa-users me-2"></i>Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/groups">
                                <i class="fas fa-layer-group me-2"></i>Groups
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/policies">
                                <i class="fas fa-shield-alt me-2"></i>Policies
                            </a>
                        </li>
                        {{end}}
                        <li class="nav-item">
                            <a class="nav-link" href="/settings">
                                <i class="fas fa-cogs me-2"></i>Settings
                            </a>
                        </li>
                    </ul>

                    <!-- User Info -->
                    <div class="mt-3 pt-3 border-top border-secondary">
                        <div class="text-center text-light">
                            <div class="small">Logged in as:</div>
                            <div class="fw-bold">{{.username}}</div>
                            <div class="badge bg-primary mt-1">{{.policy_name}}</div>
                        </div>
                    </div>

                    <div class="mt-auto pt-4">
                        <form action="/logout" method="POST">
                            <button type="submit" class="btn btn-outline-light w-100">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </button>
                        </form>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Access Keys & Users</h1>
                    <div>
                        <button type="button" class="btn btn-outline-info me-2" onclick="exportAccessKeys()">
                            <i class="fas fa-download me-2"></i>Export Keys
                        </button>
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="toggleView()">
                            <i class="fas fa-eye me-2"></i>Toggle View
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#createUserModal">
                            <i class="fas fa-user-plus me-2"></i>Create User
                        </button>
                    </div>
                </div>

                <!-- View Toggle Info -->
                <div class="alert alert-info" id="viewInfo">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="viewInfoText">Showing detailed user information. Click "Toggle View" to see access keys
                        only.</span>
                </div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead id="tableHeader">
                                    <tr>
                                        <th>Access Key</th>
                                        <th>Status</th>
                                        <th>Policy</th>
                                        <th>Groups</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    {{range .users}}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-key me-2 text-primary"></i>
                                                <code class="user-access-key me-2">{{.AccessKey}}</code>
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="copyAccessKey('{{.AccessKey}}')" title="Copy Access Key">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td class="user-status">
                                            {{if eq .Status "enabled"}}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Enabled
                                            </span>
                                            {{else}}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Disabled
                                            </span>
                                            {{end}}
                                        </td>
                                        <td class="user-policy">
                                            {{if .PolicyName}}
                                            <span class="badge bg-info">{{.PolicyName}}</span>
                                            {{else}}
                                            <span class="text-muted">No policy</span>
                                            {{end}}
                                        </td>
                                        <td class="user-groups">
                                            {{range .MemberOf}}
                                            <span class="badge bg-secondary me-1">{{.}}</span>
                                            {{else}}
                                            <span class="text-muted">No groups</span>
                                            {{end}}
                                        </td>
                                        <td class="user-actions">
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="viewUserDetails('{{.AccessKey}}')" title="View Details">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info"
                                                    onclick="editUser('{{.AccessKey}}')" title="Edit Credentials">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary"
                                                    onclick="editUserPolicy('{{.AccessKey}}')" title="Edit Policy">
                                                    <i class="fas fa-shield-alt"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning"
                                                    onclick="editUserGroups('{{.AccessKey}}')" title="Edit Groups">
                                                    <i class="fas fa-layer-group"></i>
                                                </button>
                                                {{if eq .Status "enabled"}}
                                                <button class="btn btn-sm btn-outline-warning"
                                                    onclick="toggleUserStatus('{{.AccessKey}}', false)"
                                                    title="Disable User">
                                                    <i class="fas fa-user-slash"></i>
                                                </button>
                                                {{else}}
                                                <button class="btn btn-sm btn-outline-success"
                                                    onclick="toggleUserStatus('{{.AccessKey}}', true)"
                                                    title="Enable User">
                                                    <i class="fas fa-user-check"></i>
                                                </button>
                                                {{end}}
                                                <button class="btn btn-sm btn-outline-danger"
                                                    onclick="deleteUser('{{.AccessKey}}')" title="Delete User">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createUserForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="userAccessKey" class="form-label">Access Key</label>
                            <input type="text" class="form-control" id="userAccessKey" name="access_key" required
                                minlength="3" maxlength="20">
                            <div class="form-text">3-20 characters, alphanumeric</div>
                        </div>
                        <div class="mb-3">
                            <label for="userSecretKey" class="form-label">Secret Key</label>
                            <input type="password" class="form-control" id="userSecretKey" name="secret_key" required
                                minlength="8">
                            <div class="form-text">Minimum 8 characters</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmSecretKey" class="form-label">Confirm Secret Key</label>
                            <input type="password" class="form-control" id="confirmSecretKey" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Access Key:</strong></td>
                                    <td><code id="detailsAccessKey">-</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span id="detailsStatus">-</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Policy:</strong></td>
                                    <td><span id="detailsPolicy">-</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Groups:</strong></td>
                                    <td><span id="detailsGroups">-</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Last Updated:</strong></td>
                                    <td><span id="detailsUpdatedAt">-</span></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-info" onclick="editUserFromDetails()">
                                    <i class="fas fa-edit me-2"></i>Edit Credentials
                                </button>
                                <button class="btn btn-outline-primary" onclick="editUserPolicyFromDetails()">
                                    <i class="fas fa-shield-alt me-2"></i>Edit Policy
                                </button>
                                <button class="btn btn-outline-secondary" onclick="copyAccessKeyFromDetails()">
                                    <i class="fas fa-copy me-2"></i>Copy Access Key
                                </button>
                                <button class="btn btn-outline-secondary" onclick="editUserGroupsFromDetails()">
                                    <i class="fas fa-users me-2"></i>Edit Groups
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User Credentials</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserForm">
                    <div class="modal-body">
                        <input type="hidden" id="editUserAccessKey" name="access_key">

                        <!-- Current Credentials Section -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Current Credentials</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="editUserAccessKeyDisplay" class="form-label">Access Key</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="editUserAccessKeyDisplay" readonly>
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="copyToClipboard('editUserAccessKeyDisplay')"
                                            title="Copy Access Key">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editUserCurrentSecretKey" class="form-label">Current Secret Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="editUserCurrentSecretKey"
                                            readonly>
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="toggleSecretKeyVisibility('editUserCurrentSecretKey')"
                                            title="Toggle Visibility">
                                            <i class="fas fa-eye" id="editUserCurrentSecretKeyIcon"></i>
                                        </button>
                                    </div>
                                    <div class="form-text text-muted">Secret key is masked for security</div>
                                </div>
                                <div class="mb-0">
                                    <small class="text-muted">
                                        <strong>Status:</strong> <span id="editUserStatus">-</span> |
                                        <strong>Policy:</strong> <span id="editUserPolicy">-</span> |
                                        <strong>Last Updated:</strong> <span id="editUserUpdated">-</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- New Credentials Section -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Update Secret Key</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="editUserSecretKey" class="form-label">New Secret Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="editUserSecretKey"
                                            name="secret_key" minlength="8" placeholder="Enter new secret key">
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="toggleSecretKeyVisibility('editUserSecretKey')"
                                            title="Toggle Visibility">
                                            <i class="fas fa-eye" id="editUserSecretKeyIcon"></i>
                                        </button>
                                        <button class="btn btn-outline-info" type="button" onclick="generateSecretKey()"
                                            title="Generate Random Secret Key">
                                            <i class="fas fa-random"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Minimum 8 characters. Leave empty to keep current secret key.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editConfirmSecretKey" class="form-label">Confirm New Secret Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="editConfirmSecretKey">
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="toggleSecretKeyVisibility('editConfirmSecretKey')"
                                            title="Toggle Visibility">
                                            <i class="fas fa-eye" id="editConfirmSecretKeyIcon"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Credentials</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Policy Modal -->
    <div class="modal fade" id="editPolicyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User Policy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editPolicyForm">
                    <div class="modal-body">
                        <input type="hidden" id="editPolicyAccessKey" name="access_key">
                        <div class="mb-3">
                            <label for="editPolicyAccessKeyDisplay" class="form-label">User</label>
                            <input type="text" class="form-control" id="editPolicyAccessKeyDisplay" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="userPolicy" class="form-label">Policy Name</label>
                            <select class="form-select" id="userPolicy" name="policy" required>
                                <option value="">Loading policies...</option>
                            </select>
                            <div class="form-text">Select a policy to assign to this user</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Policy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Groups Modal -->
    <div class="modal fade" id="editUserGroupsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User Groups</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserGroupsForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="userNameGroupsDisplay" class="form-label">User</label>
                            <input type="text" class="form-control" id="userNameGroupsDisplay" readonly>
                            <input type="hidden" id="editGroupsUserName" name="userName">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Current Groups</label>
                            <div id="currentUserGroups" class="border rounded p-3 bg-light">
                                <span class="text-muted">Loading...</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="userGroupsSelect" class="form-label">Select Groups</label>
                            <select multiple class="form-control" id="userGroupsSelect" name="groups" size="6">
                                <option disabled>Loading groups...</option>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple groups</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Update Groups
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isAccessKeyOnlyView = false;

        // Copy access key to clipboard
        async function copyAccessKey(accessKey) {
            try {
                await navigator.clipboard.writeText(accessKey);

                // Visual feedback
                const button = event.target.closest('button');
                const icon = button.querySelector('i');
                const originalClass = icon.className;

                icon.className = 'fas fa-check copy-success';
                button.title = 'Copied!';

                setTimeout(() => {
                    icon.className = originalClass;
                    button.title = 'Copy Access Key';
                }, 2000);

                console.log(`Access key copied: ${accessKey}`);
            } catch (err) {
                console.error('Failed to copy access key:', err);

                // Fallback: select text
                const range = document.createRange();
                const selection = window.getSelection();
                const accessKeyElement = event.target.closest('td').querySelector('.user-access-key');
                range.selectNodeContents(accessKeyElement);
                selection.removeAllRanges();
                selection.addRange(range);

                alert('Access key selected. Press Ctrl+C to copy.');
            }
        }

        // Toggle between full view and access keys only view
        function toggleView() {
            const table = document.getElementById('usersTable');
            const viewInfo = document.getElementById('viewInfoText');

            isAccessKeyOnlyView = !isAccessKeyOnlyView;

            if (isAccessKeyOnlyView) {
                table.classList.add('access-key-only-view');
                viewInfo.textContent = 'Showing access keys only. Click "Toggle View" to see full user information.';

                // Update table header
                const header = document.getElementById('tableHeader');
                header.innerHTML = `
                    <tr>
                        <th>Access Key</th>
                        <th>Actions</th>
                    </tr>
                `;
            } else {
                table.classList.remove('access-key-only-view');
                viewInfo.textContent = 'Showing detailed user information. Click "Toggle View" to see access keys only.';

                // Restore full table header
                const header = document.getElementById('tableHeader');
                header.innerHTML = `
                    <tr>
                        <th>Access Key</th>
                        <th>Status</th>
                        <th>Policy</th>
                        <th>Groups</th>
                        <th>Actions</th>
                    </tr>
                `;
            }

            console.log(`View toggled: ${isAccessKeyOnlyView ? 'Access Keys Only' : 'Full View'}`);
        }

        // Export access keys to CSV
        function exportAccessKeys() {
            try {
                // Get all access keys from the table
                const accessKeys = [];
                const rows = document.querySelectorAll('#usersTableBody tr');

                rows.forEach(row => {
                    const accessKeyElement = row.querySelector('.user-access-key');
                    const statusElement = row.querySelector('.user-status .badge');
                    const policyElement = row.querySelector('.user-policy .badge');

                    if (accessKeyElement) {
                        const accessKey = accessKeyElement.textContent.trim();
                        const status = statusElement ? statusElement.textContent.trim() : 'Unknown';
                        const policy = policyElement ? policyElement.textContent.trim() : 'No policy';

                        accessKeys.push({
                            accessKey,
                            status,
                            policy
                        });
                    }
                });

                // Create CSV content
                const csvHeader = 'Access Key,Status,Policy\\n';
                const csvRows = accessKeys.map(item =>
                    `"${item.accessKey}","${item.status}","${item.policy}"`
                ).join('\\n');
                const csvContent = csvHeader + csvRows;

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `minio-access-keys-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log(`Exported ${accessKeys.length} access keys`);

                // Show success message
                const exportBtn = event.target.closest('button');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-check me-2"></i>Exported!';
                exportBtn.classList.add('btn-success');
                exportBtn.classList.remove('btn-outline-info');

                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.classList.remove('btn-success');
                    exportBtn.classList.add('btn-outline-info');
                }, 2000);

            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export access keys: ' + error.message);
            }
        }

        let currentUserForDetails = '';

        // View user details
        async function viewUserDetails(accessKey) {
            currentUserForDetails = accessKey;

            try {
                // Show loading state
                document.getElementById('detailsAccessKey').textContent = 'Loading...';
                document.getElementById('detailsStatus').textContent = 'Loading...';
                document.getElementById('detailsPolicy').textContent = 'Loading...';
                document.getElementById('detailsGroups').textContent = 'Loading...';
                document.getElementById('detailsUpdatedAt').textContent = 'Loading...';

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                modal.show();

                // Load user details
                const response = await fetch(`/users/${accessKey}/details`);
                if (response.ok) {
                    const data = await response.json();
                    const details = data.details;

                    document.getElementById('detailsAccessKey').textContent = details.access_key || accessKey;

                    // Status with badge
                    const statusElement = document.getElementById('detailsStatus');
                    if (details.status === 'enabled') {
                        statusElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Enabled</span>';
                    } else {
                        statusElement.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Disabled</span>';
                    }

                    // Policy
                    const policyElement = document.getElementById('detailsPolicy');
                    if (details.policy_name) {
                        policyElement.innerHTML = `<span class="badge bg-info">${details.policy_name}</span>`;
                    } else {
                        policyElement.innerHTML = '<span class="text-muted">No policy assigned</span>';
                    }

                    // Groups
                    const groupsElement = document.getElementById('detailsGroups');
                    if (details.member_of && details.member_of.length > 0) {
                        const groupBadges = details.member_of.map(group =>
                            `<span class="badge bg-secondary me-1">${group}</span>`
                        ).join('');
                        groupsElement.innerHTML = groupBadges;
                    } else {
                        groupsElement.innerHTML = '<span class="text-muted">No groups</span>';
                    }

                    // Updated at
                    const updatedElement = document.getElementById('detailsUpdatedAt');
                    if (details.updated_at) {
                        const updatedDate = new Date(details.updated_at);
                        updatedElement.textContent = updatedDate.toLocaleString();
                    } else {
                        updatedElement.innerHTML = '<span class="text-muted">Not available</span>';
                    }

                    console.log(`Loaded details for user: ${accessKey}`);
                } else {
                    console.error('Failed to load user details');
                    document.getElementById('detailsAccessKey').textContent = accessKey;
                    document.getElementById('detailsStatus').textContent = 'Error loading details';
                    document.getElementById('detailsPolicy').textContent = 'Error';
                    document.getElementById('detailsGroups').textContent = 'Error';
                    document.getElementById('detailsUpdatedAt').textContent = 'Error';
                }
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('Failed to load user details: ' + error.message);
            }
        }

        // Helper functions for actions from details modal
        function editUserFromDetails() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
            modal.hide();
            setTimeout(() => editUser(currentUserForDetails), 300);
        }

        function editUserPolicyFromDetails() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
            modal.hide();
            setTimeout(() => editUserPolicy(currentUserForDetails), 300);
        }

        async function copyAccessKeyFromDetails() {
            await copyAccessKey(currentUserForDetails);
        }

        function editUserGroupsFromDetails() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
            modal.hide();
            setTimeout(() => editUserGroups(currentUserForDetails), 300);
        }

        // Load policies for dropdowns
        async function loadPolicies() {
            try {
                const response = await fetch('/api/policies');
                if (response.ok) {
                    const data = await response.json();
                    const policySelect = document.getElementById('userPolicy');
                    policySelect.innerHTML = '<option value="">Select Policy</option>';

                    data.policies.forEach(policy => {
                        const option = document.createElement('option');
                        option.value = policy;
                        option.textContent = policy;
                        policySelect.appendChild(option);
                    });

                    console.log(`Loaded ${data.policies.length} policies`);
                } else {
                    console.error('Failed to load policies');
                    const policySelect = document.getElementById('userPolicy');
                    policySelect.innerHTML = '<option value="">Error loading policies</option>';
                }
            } catch (error) {
                console.error('Error loading policies:', error);
            }
        }

        // Create user
        document.getElementById('createUserForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const secretKey = document.getElementById('userSecretKey').value;
            const confirmSecretKey = document.getElementById('confirmSecretKey').value;

            if (secretKey !== confirmSecretKey) {
                alert('Secret keys do not match');
                return;
            }

            const formData = new FormData(this);

            try {
                const response = await fetch('/users', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error creating user: ' + error.message);
            }
        });

        // Edit user (credentials)
        async function editUser(accessKey) {
            // Set access key
            document.getElementById('editUserAccessKey').value = accessKey;
            document.getElementById('editUserAccessKeyDisplay').value = accessKey;

            // Clear new credential fields
            document.getElementById('editUserSecretKey').value = '';
            document.getElementById('editConfirmSecretKey').value = '';

            // Reset current credential fields with loading state
            document.getElementById('editUserCurrentSecretKey').value = 'Loading...';
            document.getElementById('editUserStatus').textContent = 'Loading...';
            document.getElementById('editUserPolicy').textContent = 'Loading...';
            document.getElementById('editUserUpdated').textContent = 'Loading...';

            try {
                // Load current credentials
                const response = await fetch(`/users/${accessKey}/credentials`);
                if (response.ok) {
                    const result = await response.json();
                    const credentials = result.credentials;

                    // Display current credentials
                    document.getElementById('editUserCurrentSecretKey').value = credentials.secret_key || '••••••••••••••••';
                    document.getElementById('editUserStatus').textContent = credentials.status || 'Unknown';
                    document.getElementById('editUserPolicy').textContent = credentials.policy_name || 'No policy';
                    document.getElementById('editUserUpdated').textContent = credentials.updated_at ?
                        new Date(credentials.updated_at).toLocaleString() : 'Unknown';

                    console.log(`Loaded credentials for ${accessKey}`);
                } else {
                    console.error('Failed to load credentials');
                    document.getElementById('editUserCurrentSecretKey').value = 'Error loading';
                    document.getElementById('editUserStatus').textContent = 'Error';
                    document.getElementById('editUserPolicy').textContent = 'Error';
                    document.getElementById('editUserUpdated').textContent = 'Error';
                }
            } catch (error) {
                console.error('Error loading credentials:', error);
                document.getElementById('editUserCurrentSecretKey').value = 'Error loading';
                document.getElementById('editUserStatus').textContent = 'Error';
                document.getElementById('editUserPolicy').textContent = 'Error';
                document.getElementById('editUserUpdated').textContent = 'Error';
            }

            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        // Update user credentials
        document.getElementById('editUserForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const accessKey = document.getElementById('editUserAccessKey').value;
            const secretKey = document.getElementById('editUserSecretKey').value;
            const confirmSecretKey = document.getElementById('editConfirmSecretKey').value;

            // If secret key is provided, validate it
            if (secretKey) {
                if (secretKey !== confirmSecretKey) {
                    alert('Secret keys do not match');
                    return;
                }

                if (secretKey.length < 8) {
                    alert('Secret key must be at least 8 characters');
                    return;
                }

                try {
                    const response = await fetch(`/users/${accessKey}/credentials`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ secret_key: secretKey })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Close modal and reload page
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                        modal.hide();
                        alert('User credentials updated successfully');
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error updating user: ' + error.message);
                }
            } else {
                // No secret key provided, just close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                modal.hide();
            }
        });

        // Toggle user status
        async function toggleUserStatus(accessKey, enabled) {
            const action = enabled ? 'enable' : 'disable';
            if (confirm(`Are you sure you want to ${action} user "${accessKey}"?`)) {
                try {
                    const response = await fetch(`/users/${accessKey}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ enabled: enabled })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert(`Error ${action}ing user: ` + error.message);
                }
            }
        }

        // Delete user
        async function deleteUser(accessKey) {
            if (confirm(`Are you sure you want to delete user "${accessKey}"?`)) {
                try {
                    const response = await fetch(`/users/${accessKey}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error deleting user: ' + error.message);
                }
            }
        }

        // Edit user policy
        async function editUserPolicy(accessKey) {
            document.getElementById('editPolicyAccessKey').value = accessKey;
            document.getElementById('editPolicyAccessKeyDisplay').value = accessKey;

            // Load current user policy
            try {
                const response = await fetch(`/users/${accessKey}/policy`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('userPolicy').value = data.policy || '';
                    console.log(`Current policy for ${accessKey}: ${data.policy || 'none'}`);
                } else {
                    console.log('Failed to load current policy');
                }
            } catch (error) {
                console.error('Error loading current policy:', error);
            }

            const modal = new bootstrap.Modal(document.getElementById('editPolicyModal'));
            modal.show();
        }

        // Update user policy
        document.getElementById('editPolicyForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const accessKey = document.getElementById('editPolicyAccessKey').value;
            const formData = new FormData(this);

            try {
                const response = await fetch(`/users/${accessKey}/policy`, {
                    method: 'PUT',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editPolicyModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating policy: ' + error.message);
            }
        });

        // Edit user groups
        async function editUserGroups(accessKey) {
            document.getElementById('editGroupsUserName').value = accessKey;
            document.getElementById('userNameGroupsDisplay').value = accessKey;

            // Load current user groups
            try {
                const response = await fetch(`/users/${accessKey}/groups`);
                if (response.ok) {
                    const data = await response.json();
                    const groups = data.groups;

                    // Display current groups
                    const currentGroupsElement = document.getElementById('currentUserGroups');
                    currentGroupsElement.innerHTML = '';
                    if (groups && groups.length > 0) {
                        groups.forEach(group => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-1';
                            badge.textContent = group;
                            currentGroupsElement.appendChild(badge);
                        });
                    } else {
                        currentGroupsElement.innerHTML = '<span class="text-muted">No groups</span>';
                    }

                    // Load all groups for selection
                    const allGroupsResponse = await fetch('/api/groups');
                    if (allGroupsResponse.ok) {
                        const allGroupsData = await allGroupsResponse.json();
                        const allGroups = allGroupsData.groups;

                        const userGroupsSelect = document.getElementById('userGroupsSelect');
                        userGroupsSelect.innerHTML = '';

                        allGroups.forEach(group => {
                            const option = document.createElement('option');
                            option.value = group;
                            option.textContent = group;
                            userGroupsSelect.appendChild(option);
                        });

                        // Pre-select user's groups
                        groups.forEach(group => {
                            const option = Array.from(userGroupsSelect.options).find(opt => opt.value === group);
                            if (option) {
                                option.selected = true;
                            }
                        });

                        console.log(`Loaded ${allGroups.length} groups`);
                    } else {
                        console.error('Failed to load groups');
                        document.getElementById('userGroupsSelect').innerHTML = '<option disabled>Error loading groups</option>';
                    }
                } else {
                    console.log('Failed to load current groups');
                }
            } catch (error) {
                console.error('Error loading groups:', error);
            }

            const modal = new bootstrap.Modal(document.getElementById('editUserGroupsModal'));
            modal.show();
        }

        // Update user groups
        document.getElementById('editUserGroupsForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const accessKey = document.getElementById('editGroupsUserName').value;
            const formData = new FormData(this);

            try {
                const response = await fetch(`/users/${accessKey}/groups`, {
                    method: 'PUT',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserGroupsModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating groups: ' + error.message);
            }
        });

        // Helper function to toggle secret key visibility
        function toggleSecretKeyVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + 'Icon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Helper function to copy text to clipboard
        async function copyToClipboard(inputId) {
            const input = document.getElementById(inputId);
            try {
                await navigator.clipboard.writeText(input.value);

                // Visual feedback
                const button = event.target.closest('button');
                const icon = button.querySelector('i');
                const originalClass = icon.className;

                icon.className = 'fas fa-check text-success';
                setTimeout(() => {
                    icon.className = originalClass;
                }, 1000);
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                alert('Failed to copy to clipboard');
            }
        }

        // Helper function to generate random secret key
        function generateSecretKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let secretKey = '';
            for (let i = 0; i < 16; i++) {
                secretKey += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            document.getElementById('editUserSecretKey').value = secretKey;
            document.getElementById('editConfirmSecretKey').value = secretKey;

            // Show the generated key temporarily
            const input = document.getElementById('editUserSecretKey');
            const icon = document.getElementById('editUserSecretKeyIcon');
            const confirmInput = document.getElementById('editConfirmSecretKey');
            const confirmIcon = document.getElementById('editConfirmSecretKeyIcon');

            input.type = 'text';
            confirmInput.type = 'text';
            icon.className = 'fas fa-eye-slash';
            confirmIcon.className = 'fas fa-eye-slash';

            // Hide after 3 seconds
            setTimeout(() => {
                input.type = 'password';
                confirmInput.type = 'password';
                icon.className = 'fas fa-eye';
                confirmIcon.className = 'fas fa-eye';
            }, 3000);
        }

        // Load policies when page loads
        document.addEventListener('DOMContentLoaded', function () {
            loadPolicies();
        });
    </script>
</body>

</html>
